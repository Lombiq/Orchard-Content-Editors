@using Lombiq.ContentEditors.Constants
@using Lombiq.ContentEditors.ViewModels
@using Orchard.Services

@{
    var viewModel = Model.ViewModel as AsyncEditorLoaderViewModel;

    Script.Require(ResourceNames.Lombiq_AsyncEditor).AtHead();

    viewModel.ContentItemId = viewModel.ContentItemId ?? 0;

    viewModel.EditUrl = string.IsNullOrEmpty(viewModel.EditUrl)
        ? Url.Action("Edit", "AsyncEditor", new { Area = "Lombiq.ContentEditors" })
        : viewModel.EditUrl;

    viewModel.ProcessingIndicatorElementClass = viewModel.UseStaticLoadingIndicator
        ? string.Empty
        : ".js-" + ElementNames.AsyncEditorLoader.ProcessingIndicatorElementName;

    viewModel.AsyncEditorLoaderId = Html.AsyncEditorPluginId(viewModel.ContentType);
}

@Display.Lombiq_AsyncEditorLoader_Container(AsyncEditorLoaderId: viewModel.AsyncEditorLoaderId)

@Html.Hidden(viewModel.AsyncEditorLoaderId + "options", WorkContext.Resolve<IJsonConverter>().Serialize(viewModel))

<script type="text/javascript">
    ; (function ($) {
        $(function () {
            $("#@viewModel.AsyncEditorLoaderId").lombiq_AsyncEditor({
                asyncEditorApiUrl: "@viewModel.EditUrl",
                contentType: "@viewModel.ContentType",
                initialContentItemId: "@viewModel.ContentItemId",
                defaultEditorGroupName: "@viewModel.EditorGroup",
                asyncEditorLoaderElementClass: "@viewModel.AsyncEditorLoaderElementClass",
                processingIndicatorElementClass: "@viewModel.ProcessingIndicatorElementClass",
                editorPlaceholderElementClass: "@viewModel.EditorPlaceholderElementClass",
                loadEditorActionElementClass: "@viewModel.LoadEditorActionElementClass",
                postEditorActionElementClass: "@viewModel.PostEditorActionElementClass",
                dirtyFormLeaveConfirmationText: "@viewModel.DirtyFormLeaveConfirmationText",
            });
        });
    })(jQuery);
</script>