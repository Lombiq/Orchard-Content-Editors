@using Lombiq.ContentEditors.ViewModels
@using Lombiq.ContentEditors.Constants
@using Orchard.Localization.Services
@using Orchard.Localization.Models
@using Orchard.Utility.Extensions

@{
    Style.Require(ResourceNames.Lombiq_Editors_DateTimeEditor);

    Script.Require(ResourceNames.Lombiq_Editors_DateTimeEditor).AtHead();

    var viewModel = Model.ViewModel as DateTimeEditorViewModel;

    if (viewModel.EditorType == DateTimeEditorType.Time)
    {
        Script.Require(ResourceNames.jQueryTimeEntry).AtHead();
    }

    var isDateEditor = viewModel.EditorType == DateTimeEditorType.Date ||
        viewModel.EditorType == DateTimeEditorType.DateWithTimeZoneConversion;

    var classifiedName = $"{Html.NameForModel()}-{viewModel.Name}".HtmlClassify();
    var hiddenFieldClassName = "js-" + classifiedName + "-value";
    var editorType = isDateEditor ? "text" : "time";

    string DefaultBlockName = "dateTimeEditor";
    string BlockName = viewModel.BlockName ?? DefaultBlockName;
    string DateTimePickerContainerElementName = DefaultBlockName + "__dateTimePickerContainer";
    string GlyphiconElementName = DefaultBlockName + "__glyphicon";

    var editorTypeClass = isDateEditor ? "datePicker" : "timePicker";

    var dateTimePickerAttributes = viewModel.BuildAttributes(new Dictionary<string, object>
    {
        { "type", editorType },
        { "class", $"form-control {editorTypeClass} {DefaultBlockName}__{editorTypeClass} {classifiedName}" }
    });

    var labelAttributes = new Dictionary<string, object>
    {
        { "class", "editorLabel " + DefaultBlockName + "__label" }
    };

    if (viewModel.Required)
    {
        dateTimePickerAttributes["required"] = true;
        dateTimePickerAttributes["class"] = dateTimePickerAttributes["class"] + " required";
        labelAttributes["class"] = labelAttributes["class"] + " required";
    }

    if (!string.IsNullOrEmpty(viewModel.Placeholder))
    {
        dateTimePickerAttributes["placeholder"] = viewModel.Placeholder;
    }

    var dateLocalizationServices = WorkContext.Resolve<IDateLocalizationServices>();
    var options = new DateLocalizationOptions
    {
        EnableTimeZoneConversion = viewModel.EditorType == DateTimeEditorType.Time ||
            viewModel.EditorType == DateTimeEditorType.DateWithTimeZoneConversion,
        EnableCalendarConversion = viewModel.EditorType == DateTimeEditorType.Date,
        IgnoreDate = viewModel.EditorType == DateTimeEditorType.Time
    };

    var displayFormat = isDateEditor ? viewModel.MomentJsDateDisplayFormat : "HH:mm";
    var dateTimeString = viewModel.Value as string;
    if (viewModel.Value is DateTime?)
    {
        var value = viewModel.Value as DateTime?;
        dateTimeString = value.HasValue && value.Value != default(DateTime) ?
            viewModel.Value is string ?
                (string)viewModel.Value :
                dateLocalizationServices.ConvertToLocalizedString(value, T("yyyy-MM-dd").Text, options) :
            "";
    }

    var datePickerElement = new TagBuilder("input");
    foreach (var attribute in dateTimePickerAttributes)
    {
        datePickerElement.Attributes.Add(attribute.Key, attribute.Value.ToString());
    }
    datePickerElement.Attributes.Add("value", dateTimeString);
}

<div class="editor editorField form-group @DefaultBlockName @BlockName">
    @if (!string.IsNullOrEmpty(viewModel.Label))
    {
        @Html.Label(viewModel.Name, viewModel.Label, labelAttributes)
    }

    <div class="@DateTimePickerContainerElementName">
        @Html.Raw(datePickerElement.ToString(TagRenderMode.SelfClosing))
        @Html.Hidden(viewModel.Name, dateTimeString, new { @class = hiddenFieldClassName })
    </div>
</div>

@if (editorType == "text")
{
    <script type="text/javascript">
        ; (function ($) {
            $(function () {
                var $datepicker = $(".@classifiedName");
                var $hiddenfield = $datepicker.siblings(".@hiddenFieldClassName");
                $datepicker.datepicker({
                    showButtonPanel: true,
                    dateFormat: "@displayFormat",
                    showOn: "button",
                    buttonImage: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABcAAAAYCAYAAAARfGZ1AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA+5pVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOmRjPSJodHRwOi8vcHVybC5vcmcvZGMvZWxlbWVudHMvMS4xLyIgeG1wTU06T3JpZ2luYWxEb2N1bWVudElEPSJ1dWlkOjY1RTYzOTA2ODZDRjExREJBNkUyRDg4N0NFQUNCNDA3IiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjg0M0YyRDVDMDY3QjExRTI5OUZEQTZGODg4RDc1ODdCIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjg0M0YyRDVCMDY3QjExRTI5OUZEQTZGODg4RDc1ODdCIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDUzYgKE1hY2ludG9zaCkiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDowMTgwMTE3NDA3MjA2ODExODA4M0ZFMkJBM0M1RUU2NSIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDowNjgwMTE3NDA3MjA2ODExODA4M0U3NkRBMDNEMDVDMSIvPiA8ZGM6dGl0bGU+IDxyZGY6QWx0PiA8cmRmOmxpIHhtbDpsYW5nPSJ4LWRlZmF1bHQiPmdseXBoaWNvbnM8L3JkZjpsaT4gPC9yZGY6QWx0PiA8L2RjOnRpdGxlPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PqXA0YIAAABnSURBVHjaYvj//z8DDAPBAiAGMRYgixPCuPQxQiXBgJGREc4BijMyEAnw6YPZSm28gBHKoAkYwoYjR+hosAwjw5FzFijHUcoH0UwMNAQ0NXw0zEfDfDTMKQTMQKwIxAY0MHshQIABAFt8pXTQ5lYVAAAAAElFTkSuQmCC",
                    buttonImageOnly: true,
                    onSelect: function () {
                        $hiddenfield.val(moment($(this).datepicker("getDate")).format("YYYY-MM-DD"));
                    }
                });

                $datepicker.on("change", function () {
                    var value = $datepicker.val();
                    if (value.length > 0) {
                        var parsedMomentDate = moment(value, "@displayFormat");
                        if (parsedMomentDate.isValid()) {
                            $hiddenfield.val(parsedMomentDate.format("YYYY-MM-DD"));
                        }
                        else {
                            alert('@T("Date value has invalid format. The expected date format is \"{0}\".", displayFormat)');
                            $hiddenfield.val("");
                        }
                    }
                    else {
                        $hiddenfield.val("");
                    }
                });

                @if (!string.IsNullOrEmpty(dateTimeString))
                { 
                    @:$datepicker.datepicker("setDate", new Date("@dateTimeString"));
                }
                
                $(".ui-datepicker").hide();
            });
        })(jQuery);
    </script>
}